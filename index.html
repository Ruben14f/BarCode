<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Lector de C√≥digos (QR + Barra)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- ZXing TypeScript port (UMD, expone objeto global ZXing) -->
  <script src="https://unpkg.com/@zxing/library@latest/umd/index.min.js"></script>

  <style>
    :root {
      --bg: #0b1020;
      --card: #151b2d;
      --accent: #00ff7f;
      --accent-soft: rgba(0, 255, 127, 0.25);
      --text: #f7f7ff;
      --text-muted: #a0aec0;
      --danger: #ff4b6a;
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      background: radial-gradient(circle at top, #1a2240, #050712);
      color: var(--text);
      display: flex;
      justify-content: center;
      padding: 1rem;
    }

    .app-container {
      width: 100%;
      max-width: 1000px;
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.2fr);
      gap: 1.2rem;
    }

    @media (max-width: 800px) {
      .app-container {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: var(--card);
      border-radius: 18px;
      padding: 1rem 1.2rem 1.2rem;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(255, 255, 255, 0.02);
    }

    .card h1,
    .card h2 {
      margin: 0 0 0.6rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 1.1rem;
    }

    .subtitle {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-bottom: 0.75rem;
    }

    .badge {
      font-size: 0.7rem;
      padding: 0.1rem 0.4rem;
      border-radius: 999px;
      border: 1px solid var(--accent-soft);
      color: var(--accent);
    }

    /* √Årea de esc√°ner */

    .scanner-wrapper {
      position: relative;
      width: 100%;
      max-width: 500px;
      margin: 0 auto 1rem;
      background: #000;
      border-radius: 16px;
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.12);
    }

    /* ‚ÄúFranja‚Äù tipo c√≥digo de barra: poco alto, ancho completo */
    .scanner-video-container {
      position: relative;
      width: 100%;
      height: 180px;           /* Alto reducido, estilo esc√°ner de barra */
      overflow: hidden;
      background: #000;
    }

    video#videoPreview {
      width: 100%;
      height: 100%;
      object-fit: cover;
      /* üî¥ IMPORTANTE: ya NO invertimos la c√°mara */
      /* transform: scaleX(-1);  <- eliminado */
    }

    /* L√≠nea verde central */
    .scan-line {
      position: absolute;
      left: 10%;
      right: 10%;
      top: 50%;
      height: 3px;
      transform: translateY(-50%);
      background: var(--accent);
      box-shadow:
        0 0 8px var(--accent),
        0 0 16px var(--accent-soft);
      z-index: 3;
    }

    .scan-line::before {
      content: "";
      position: absolute;
      inset: -18px 0;
      background: linear-gradient(
        to bottom,
        transparent,
        rgba(0, 255, 127, 0.15),
        transparent
      );
      pointer-events: none;
    }

    .scanner-footer {
      padding: 0.5rem 0.75rem 0.65rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
      font-size: 0.8rem;
      border-top: 1px dashed rgba(255, 255, 255, 0.1);
      background: radial-gradient(circle at bottom, #0f172a, transparent);
    }

    .status-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      margin-right: 0.4rem;
      background: #718096;
    }

    .status-dot.active {
      background: var(--accent);
      box-shadow: 0 0 8px var(--accent);
    }

    .status-text {
      color: var(--text-muted);
    }

    .status-text strong {
      color: var(--accent);
    }

    .controls-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
      align-items: center;
      margin-bottom: 0.7rem;
    }

    button {
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text);
      padding: 0.35rem 0.85rem;
      font-size: 0.8rem;
      outline: none;
      cursor: pointer;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      transition: transform 0.06s ease, box-shadow 0.06s ease, background 0.06s ease;
    }

    button:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent-soft);
    }

    button.primary {
      background: linear-gradient(135deg, #00ff7f, #37fca9);
      border-color: transparent;
      color: #02130a;
      box-shadow: 0 10px 25px rgba(0, 255, 127, 0.35);
    }

    button.primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 35px rgba(0, 255, 127, 0.45);
    }

    button.secondary:hover {
      background: rgba(31, 41, 55, 1);
    }

    button.danger {
      border-color: rgba(255, 75, 106, 0.6);
      color: var(--danger);
    }

    button.danger:hover {
      background: rgba(75, 16, 32, 0.9);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    /* Tabla de resultados */

    .table-wrapper {
      max-height: 400px;
      overflow: auto;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.78rem;
    }

    thead {
      position: sticky;
      top: 0;
      background: #0f172a;
      z-index: 1;
    }

    th,
    td {
      padding: 0.4rem 0.5rem;
      text-align: left;
      white-space: nowrap;
    }

    th {
      font-weight: 600;
      color: var(--text-muted);
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    }

    tbody tr:nth-child(even) {
      background: rgba(15, 23, 42, 0.7);
    }

    tbody tr:nth-child(odd) {
      background: rgba(15, 23, 42, 0.4);
    }

    tbody tr:hover {
      background: rgba(56, 189, 248, 0.18);
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.1rem 0.4rem;
      border-radius: 999px;
      font-size: 0.7rem;
      background: rgba(148, 163, 184, 0.18);
      color: var(--text-muted);
    }

    .tag-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--accent);
    }

    .no-data {
      text-align: center;
      padding: 0.8rem;
      color: var(--text-muted);
    }

    .records-actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.35rem;
      margin-bottom: 0.4rem;
      font-size: 0.75rem;
    }

    .helper-text {
      font-size: 0.7rem;
      color: var(--text-muted);
      margin-top: 0.2rem;
    }

    .pill-info {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      font-size: 0.72rem;
      color: var(--text-muted);
    }

    .pill-info span {
      font-size: 0.72rem;
      padding: 0.1rem 0.35rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.45);
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- PANEL IZQUIERDO: ESC√ÅNER -->
    <section class="card">
      <h1>
        üì∑ Lector de c√≥digos
        <span class="badge">QR + Barra (ZXing)</span>
      </h1>
      <p class="subtitle">
        Apunta la c√°mara hacia el c√≥digo. Alinea el c√≥digo con la
        <strong>l√≠nea verde central</strong>.
      </p>

      <div class="controls-row">
        <button id="btnStart" class="primary">
          ‚ñ∂ Iniciar esc√°ner
        </button>
        <button id="btnStop" class="secondary">
          ‚èπ Detener
        </button>
      </div>

      <div class="scanner-wrapper">
        <div class="scanner-video-container">
          <video id="videoPreview" autoplay muted playsinline></video>
          <div class="scan-line"></div>
        </div>
        <div class="scanner-footer">
          <div style="display:flex;align-items:center;gap:0.4rem;">
            <span id="statusDot" class="status-dot"></span>
            <span id="statusText" class="status-text">C√°mara detenida</span>
          </div>
          <div class="pill-info">
            <span>Datos guardados en el navegador (localStorage)</span>
          </div>
        </div>
      </div>

      <p class="helper-text">
        Por cada c√≥digo se pedir√° el
        <strong>Nombre de la persona</strong>. Es obligatorio ingresar un nombre.
      </p>
    </section>

    <!-- PANEL DERECHO: REGISTROS -->
    <section class="card">
      <h2>
        üßæ Registros escaneados
        <span class="badge">Exportable a CSV / Excel</span>
      </h2>
      <p class="subtitle">
        Los datos se guardan autom√°ticamente en el almacenamiento local del navegador.
      </p>

      <div class="records-actions">
        <button id="btnExport" class="secondary">‚¨á Exportar CSV</button>
        <button id="btnClear" class="danger">üóë Limpiar registros</button>
      </div>

      <div class="table-wrapper">
        <table id="recordsTable">
          <thead>
            <tr>
              <th>#</th>
              <th>C√≥digo</th>
              <th>Tipo</th>
              <th>Nombre</th>
              <th>Fecha / Hora</th>
            </tr>
          </thead>
          <tbody id="recordsBody">
            <!-- Filas din√°micas -->
          </tbody>
        </table>
      </div>
      <div id="noDataMsg" class="no-data" style="display:none;">
        A√∫n no hay c√≥digos escaneados.
      </div>
    </section>
  </div>

  <script>
    // ====== ESTADO GLOBAL ======
    let codeReader = null;
    let isScanning = false;
    let isProcessingScan = false; // üëà para evitar loop de prompts
    let scanRecords = [];
    let lastScannedCode = null;
    let lastScanTime = 0;

    // ====== STORAGE ======
    function loadRecordsFromStorage() {
      try {
        const raw = localStorage.getItem("scanRecords");
        scanRecords = raw ? JSON.parse(raw) : [];
      } catch (e) {
        console.error("Error leyendo localStorage:", e);
        scanRecords = [];
      }
      renderRecordsTable();
    }

    function saveRecordsToStorage() {
      try {
        localStorage.setItem("scanRecords", JSON.stringify(scanRecords));
      } catch (e) {
        console.error("Error guardando en localStorage:", e);
      }
    }

    // ====== TABLA ======
    function renderRecordsTable() {
      const tbody = document.getElementById("recordsBody");
      const noDataMsg = document.getElementById("noDataMsg");
      tbody.innerHTML = "";

      if (!scanRecords.length) {
        noDataMsg.style.display = "block";
        return;
      }

      noDataMsg.style.display = "none";

      scanRecords.forEach((rec, index) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${index + 1}</td>
          <td>${rec.code}</td>
          <td>
            <span class="tag">
              <span class="tag-dot"></span>
              ${rec.type || "DESCONOCIDO"}
            </span>
          </td>
          <td>${rec.name || "-"}</td>
          <td>${rec.time}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // ====== ESTADO UI ESC√ÅNER ======
    function setScannerStatus(active, message) {
      const dot = document.getElementById("statusDot");
      const text = document.getElementById("statusText");

      if (active) {
        dot.classList.add("active");
        text.innerHTML = `<strong>Escaneando...</strong> ${message || ""}`;
      } else {
        dot.classList.remove("active");
        text.textContent = message || "C√°mara detenida";
      }
    }

    // ====== EXPORTAR CSV ======
    function exportToCSV() {
      if (!scanRecords.length) {
        alert("No hay registros para exportar.");
        return;
      }

      const header = ["N¬∞", "C√≥digo", "Tipo", "Nombre", "FechaHora"];
      let csv = header.join(";") + "\n";

      scanRecords.forEach((rec, index) => {
        const safeCode = String(rec.code).replace(/"/g, '""');
        const safeType = String(rec.type || "").replace(/"/g, '""');
        const safeName = String(rec.name || "").replace(/"/g, '""');
        const safeTime = String(rec.time || "").replace(/"/g, '""');

        csv += [
          index + 1,
          `"${safeCode}"`,
          `"${safeType}"`,
          `"${safeName}"`,
          `"${safeTime}"`
        ].join(";") + "\n";
      });

      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);

      const link = document.createElement("a");
      link.href = url;
      link.download = "lecturas_codigos.csv";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    // ====== LIMPIAR REGISTROS ======
    function clearRecords() {
      if (!confirm("¬øSeguro que quieres eliminar todos los registros guardados?")) {
        return;
      }
      scanRecords = [];
      saveRecordsToStorage();
      renderRecordsTable();
    }

    // ====== MANEJO DE ESCANEOS ======
    function handleScanResult(result) {
      if (!result) return;

      const codeText = result.text || (result.getText && result.getText()) || "";
      if (!codeText) return;

      const now = Date.now();

      // Si ya estamos procesando un c√≥digo, no hagas nada (evita loop)
      if (isProcessingScan) return;

      // (opcional) filtro anti-repetici√≥n muy r√°pida
      if (codeText === lastScannedCode && now - lastScanTime < 500) {
        return;
      }

      lastScannedCode = codeText;
      lastScanTime = now;
      isProcessingScan = true;

      // Pausar esc√°ner mientras pedimos el nombre
      if (codeReader) {
        codeReader.reset();
      }

      let format = "DESCONOCIDO";
      try {
        if (result.getBarcodeFormat) {
          format = String(result.getBarcodeFormat());
        } else if (result.barcodeFormat) {
          format = String(result.barcodeFormat);
        }
      } catch (_) {}

      // ‚úÖ Debe SI O SI ingresar un usuario (nombre no vac√≠o)
      let name;
      while (true) {
        name = prompt(
          `C√≥digo detectado:\n\n${codeText}\n\nIngresa el NOMBRE de la persona asociada a este c√≥digo (obligatorio):`
        );

        if (name === null) {
          // Si cancela, no guardamos, pero salimos del bucle
          isProcessingScan = false;
          // Si el usuario sigue con esc√°ner activo, lo reanudamos:
          if (isScanning) {
            startScanner();
          }
          return;
        }

        const trimmed = name.trim();
        if (!trimmed) {
          alert("Debes ingresar un nombre para continuar.");
          continue; // vuelve a preguntar
        }

        name = trimmed;
        break; // nombre v√°lido
      }

      const timestamp = new Date().toLocaleString();

      scanRecords.push({
        code: codeText,
        type: format,
        name: name,
        time: timestamp
      });

      saveRecordsToStorage();
      renderRecordsTable();

      // Terminamos de procesar este scan
      isProcessingScan = false;

      // Volver a escanear el siguiente c√≥digo (si el usuario no ha detenido)
      if (isScanning) {
        startScanner();
      }
    }

    // ====== INICIALIZAR ZXING ======
    function initZXing() {
      try {
        codeReader = new ZXing.BrowserMultiFormatReader();
        setScannerStatus(false, "Pulsa Iniciar para usar la c√°mara por defecto.");
      } catch (err) {
        console.error("Error inicializando ZXing:", err);
        alert("No se pudo inicializar ZXing.");
        setScannerStatus(false, "Error al inicializar ZXing.");
      }
    }

    // ====== CONTROL ESC√ÅNER ======
    async function startScanner() {
      if (!codeReader) {
        alert("ZXing a√∫n no est√° listo.");
        return;
      }

      // Marcamos que el usuario quiere escanear
      isScanning = true;
      setScannerStatus(true, "Apunta el c√≥digo a la l√≠nea verde.");

      try {
        // Usar c√°mara por defecto del navegador
        await codeReader.decodeFromVideoDevice(
          null,
          "videoPreview",
          (result, err) => {
            if (result) {
              handleScanResult(result);
            }
            if (err && !(err instanceof ZXing.NotFoundException)) {
              console.error("Error de ZXing:", err);
            }
          }
        );
      } catch (err) {
        console.error("Error al iniciar esc√°ner:", err);
        alert("No se pudo iniciar el esc√°ner. Revisa permisos de c√°mara y que est√©s usando HTTPS.");
        setScannerStatus(false, "Error iniciando c√°mara.");
        isScanning = false;
      }
    }

    function stopScanner() {
      if (codeReader) {
        codeReader.reset();
      }
      isScanning = false;
      isProcessingScan = false;
      setScannerStatus(false, "C√°mara detenida.");
    }

    // ====== EVENTOS ======
    document.addEventListener("DOMContentLoaded", () => {
      loadRecordsFromStorage();
      initZXing();

      document.getElementById("btnStart").addEventListener("click", () => {
        startScanner();
      });

      document.getElementById("btnStop").addEventListener("click", () => {
        stopScanner();
      });

      document.getElementById("btnExport").addEventListener("click", () => {
        exportToCSV();
      });

      document.getElementById("btnClear").addEventListener("click", () => {
        clearRecords();
      });
    });
  </script>
</body>
</html>
