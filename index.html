<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Escáner ZXing + Personas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- ZXing JS (multi-formato, QR + barcodes) -->
  <script src="https://unpkg.com/@zxing/library@latest"></script>

  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: #222;
      background: #f5f5f5;
    }
    body {
      max-width: 900px;
      margin: 0 auto;
      padding: 16px;
    }
    h1 {
      text-align: center;
      margin-bottom: 4px;
    }
    p {
      margin: 4px 0;
    }
    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1fr);
      gap: 16px;
      margin-top: 16px;
    }
    @media (max-width: 768px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }
    .card {
      background: #fff;
      border-radius: 10px;
      padding: 12px 14px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
    }
    #preview {
      width: 100%;
      max-height: 320px;
      background: #000;
      border-radius: 8px;
    }
    .small {
      font-size: 0.8rem;
      color: #555;
    }
    .status-ok {
      color: #1b5e20;
      font-weight: 600;
    }
    .status-error {
      color: #c62828;
      font-weight: 600;
    }
    .mono {
      font-family: ui-monospace, Menlo, Monaco, Consolas, "Courier New", monospace;
      font-size: 0.8rem;
    }
    .buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 6px 12px;
      cursor: pointer;
      font-size: 0.9rem;
    }
    .btn-primary {
      background: #4f46e5;
      color: white;
    }
    .btn-danger {
      background: #fee2e2;
      color: #b91c1c;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 0.9rem;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 6px 8px;
      text-align: left;
      word-break: break-all;
    }
    th {
      background: #f0f0f0;
    }
  </style>
</head>
<body>
  <h1>Escáner ZXing + Registro de Personas</h1>
  <p class="small">
    Usa la cámara para leer <strong>QR y códigos de barra</strong>.  
    Cada lectura se asocia a un <strong>nombre de persona</strong> y se guarda en este navegador.
  </p>

  <div class="layout">
    <!-- SCANNER -->
    <div class="card">
      <h2>Escáner</h2>
      <p class="small">
        1. Permite acceso a la cámara.<br>
        2. Apunta el código al recuadro de video.<br>
        3. Al leer, te pedirá el nombre de la persona.
      </p>

      <video id="preview" muted playsinline></video>

      <p id="scan-status" class="small" style="margin-top:6px;">
        Estado: <span class="status-ok">iniciando cámara…</span>
      </p>
      <p id="last-scan" class="small mono"></p>
    </div>

    <!-- REGISTROS -->
    <div class="card">
      <h2>Registros guardados</h2>
      <p class="small">
        Los datos se guardan en <strong>localStorage</strong> (solo en este navegador / dispositivo).
      </p>

      <div class="buttons">
        <button id="btn-export" class="btn-primary">Descargar CSV</button>
        <button id="btn-clear" class="btn-danger">Borrar todo</button>
      </div>

      <div id="no-data" class="small" style="margin-top:10px;">
        Aún no hay registros. Escanea un código para empezar.
      </div>

      <table id="table-registros" style="display:none;">
        <thead>
          <tr>
            <th>#</th>
            <th>Persona</th>
            <th>Código leído</th>
            <th>Formato</th>
            <th>Fecha / Hora</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    // ====== Estado y storage ======
    const STORAGE_KEY = "registros_codigos_zxing_v1";
    let registros = [];
    let ultimoNombre = "";
    let ultimoCodigo = "";
    let ultimaLecturaMs = 0;

    const scanStatusEl = document.getElementById("scan-status");
    const lastScanEl = document.getElementById("last-scan");
    const tableEl = document.getElementById("table-registros");
    const tbodyEl = tableEl.querySelector("tbody");
    const noDataEl = document.getElementById("no-data");
    const btnExport = document.getElementById("btn-export");
    const btnClear = document.getElementById("btn-clear");

    function cargarDesdeLocalStorage() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        const arr = JSON.parse(raw);
        if (Array.isArray(arr)) {
          registros = arr;
        }
      } catch (e) {
        console.error("No se pudo leer localStorage", e);
      }
    }

    function guardarEnLocalStorage() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(registros));
      } catch (e) {
        console.error("No se pudo guardar en localStorage", e);
      }
    }

    function formatearFecha(iso) {
      const d = new Date(iso);
      if (isNaN(d)) return "";
      const pad = n => n.toString().padStart(2, "0");
      return (
        pad(d.getDate()) + "-" +
        pad(d.getMonth() + 1) + "-" +
        d.getFullYear() + " " +
        pad(d.getHours()) + ":" +
        pad(d.getMinutes())
      );
    }

    function renderTabla() {
      if (!registros.length) {
        noDataEl.style.display = "block";
        tableEl.style.display = "none";
        return;
      }
      noDataEl.style.display = "none";
      tableEl.style.display = "table";

      tbodyEl.innerHTML = "";
      registros.forEach((r, idx) => {
        const tr = document.createElement("tr");

        const tdIdx = document.createElement("td");
        tdIdx.textContent = (idx + 1).toString();
        tr.appendChild(tdIdx);

        const tdNom = document.createElement("td");
        tdNom.textContent = r.nombre;
        tr.appendChild(tdNom);

        const tdCod = document.createElement("td");
        tdCod.textContent = r.codigo;
        tr.appendChild(tdCod);

        const tdFmt = document.createElement("td");
        tdFmt.textContent = r.formato || "";
        tr.appendChild(tdFmt);

        const tdFecha = document.createElement("td");
        tdFecha.textContent = formatearFecha(r.fecha);
        tr.appendChild(tdFecha);

        tbodyEl.appendChild(tr);
      });
    }

    function exportarCSV() {
      if (!registros.length) {
        alert("No hay datos para exportar.");
        return;
      }
      const encabezados = ["indice","nombre","codigo","formato","fecha_iso"];
      const filas = [encabezados.join(",")];

      registros.forEach((r, idx) => {
        const fila = [
          idx + 1,
          JSON.stringify(r.nombre || ""),
          JSON.stringify(r.codigo || ""),
          JSON.stringify(r.formato || ""),
          JSON.stringify(r.fecha || "")
        ].join(",");
        filas.push(fila);
      });

      const blob = new Blob([filas.join("\n")], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "registros_codigos_zxing.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function borrarTodo() {
      if (!confirm("¿Seguro que quieres borrar todos los registros?")) return;
      registros = [];
      guardarEnLocalStorage();
      renderTabla();
    }

    btnExport.addEventListener("click", exportarCSV);
    btnClear.addEventListener("click", borrarTodo);

    // ====== Lógica ZXing ======
    async function iniciarEscaner() {
      // Carga registros previos
      cargarDesdeLocalStorage();
      renderTabla();

      if (!window.ZXing || !ZXing.BrowserMultiFormatReader) {
        scanStatusEl.innerHTML =
          'Estado: <span class="status-error">No se pudo cargar ZXing desde CDN</span>';
        return;
      }

      const codeReader = new ZXing.BrowserMultiFormatReader();

      try {
        const devices = await codeReader.listVideoInputDevices();
        let deviceId = null;
        if (devices.length > 0) {
          // Si hay varias cámaras, intenta usar la última (en móviles suele ser la trasera)
          deviceId = devices[devices.length - 1].deviceId;
        }

        scanStatusEl.innerHTML =
          'Estado: <span class="status-ok">escaneando… apunta el código a la cámara</span>';

        codeReader.decodeFromVideoDevice(
          deviceId,            // null = cámara por defecto
          "preview",           // id del <video>
          (result, err) => {
            const ahora = Date.now();

            if (result) {
              const text = result.getText();
              const formato = result.getBarcodeFormat
                ? result.getBarcodeFormat()
                : (result.barcodeFormat || "");

              // Evitar spam del mismo código muchas veces seguidas
              if (text === ultimoCodigo && (ahora - ultimaLecturaMs) < 2000) {
                return;
              }
              ultimoCodigo = text;
              ultimaLecturaMs = ahora;

              lastScanEl.textContent =
                "Último código: " + text + (formato ? " (" + formato + ")" : "");

              scanStatusEl.innerHTML =
                'Estado: <span class="status-ok">código leído, esperando nombre…</span>';

              let nombre = prompt(
                "Código leído:\n" + text +
                (formato ? "\nFormato: " + formato : "") +
                "\n\nIngresa el nombre de la persona:",
                ultimoNombre || ""
              );

              if (!nombre) {
                scanStatusEl.innerHTML =
                  'Estado: <span class="status-error">lectura cancelada, no se guardó el código</span>';
                return;
              }

              nombre = nombre.trim();
              ultimoNombre = nombre;

              const registro = {
                nombre,
                codigo: text,
                formato: String(formato || ""),
                fecha: new Date().toISOString()
              };

              registros.push(registro);
              guardarEnLocalStorage();
              renderTabla();

              scanStatusEl.innerHTML =
                'Estado: <span class="status-ok">registro guardado para ' +
                nombre + "</span>";
            }

            if (err) {
              // Errores esperables mientras escanea (no rompe el loop)
              if (err instanceof ZXing.NotFoundException) {
                // No se encontró código en este frame, normal
              } else if (err instanceof ZXing.ChecksumException) {
                console.warn("Código encontrado pero checksum inválido");
              } else if (err instanceof ZXing.FormatException) {
                console.warn("Código encontrado con formato inválido");
              } else {
                console.error(err);
              }
            }
          }
        );
      } catch (e) {
        console.error(e);
        scanStatusEl.innerHTML =
          'Estado: <span class="status-error">Error al iniciar cámara o lector</span>';
      }
    }

    window.addEventListener("load", iniciarEscaner);
  </script>
</body>
</html>
